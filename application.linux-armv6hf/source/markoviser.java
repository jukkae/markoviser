import processing.core.*; 
import processing.data.*; 
import processing.event.*; 
import processing.opengl.*; 

import org.apache.commons.math3.*; 
import org.apache.commons.math3.distribution.*; 
import oscP5.*; 
import netP5.*; 

import java.util.HashMap; 
import java.util.ArrayList; 
import java.io.File; 
import java.io.BufferedReader; 
import java.io.PrintWriter; 
import java.io.InputStream; 
import java.io.OutputStream; 
import java.io.IOException; 

public class markoviser extends PApplet {







OscP5 oscP5;
NetAddress puredata;

Markov markov;
Markov rhythmM;

public void setup() {
  
  
  oscP5 = new OscP5(this, 12000);
  
  puredata = new NetAddress("127.0.0.1", 12001); 
  markov = new Markov();
  rhythmM = new Markov();
}

public void draw() {
  background(0);
}

public void mouseClicked() {
  oscP5.send(new OscMessage("/state").add(markov.getState()), puredata);
}

public void oscEvent(OscMessage message) {
  if(message.checkAddrPattern("/lerp1")) {
    float lerp = (float) message.arguments()[0];
    markov.lerpMatricesA(lerp);
  }
  if(message.checkAddrPattern("/lerp2")) {
    float lerp = (float) message.arguments()[0];
    markov.lerpMatricesB(lerp);
  }
  for(int i = 0; i < message.arguments().length; i++) {
    if(message.arguments()[i].equals("getnextnote")){
      int next = markov.getNextNote();
      sendInt(next);
    }
    if(message.arguments()[i].equals("getnextvalue")) {
      int next = markov.getNextValue();
      sendValue(next);
      if(next == 16 || next == 12) sendToggle(0); //TODO testing toggle!
    }
    if(message.arguments()[i].equals("getnextmute")) {
      int mute = markov.getNextMute();
      sendMute(mute);
    }
    if(message.arguments()[i].equals("getnextlegato")) {
      int legato = markov.getNextLegato();
      sendLegato(legato);
    }
  }
}

public void sendInt(int i) {
  oscP5.send(new OscMessage("/state").add(i), puredata);
}

public void sendValue(int i) {
  oscP5.send(new OscMessage("/value").add(i), puredata);
}

public void sendToggle(int i) {
  oscP5.send(new OscMessage("/toggle").add(i), puredata);
}

public void sendMute(int i) {
  oscP5.send(new OscMessage("/mute").add(i), puredata);
}

public void sendLegato(int i) {
  oscP5.send(new OscMessage("/legato").add(i), puredata);
}
class Markov {
  int state = 0;
  int previousState = 0;
  int value = 4;
  int previousValue = 4;
  int muting = 0;
  int previousMuting = 0;
  int legato = 0;
  int previousLegato = 0;
  
  int[] secOrdStates = {0, 2, 3, 5, 7, 8, 10, 12};
  int[] mutingStates = {0, 1, 2};
  int[] rhythmStates = {1, 2, 3, 4, 6, 8, 12, 16};
  int[] legatoStates = {0, 1};
                               
  double[][][] secondOrderProbabilitiesLerpTarget = {
                                            {//A  B  C  D  E  F  G  a  cur  last
                                              {1, 1, 2, 0, 2, 0, 0, 1}, //A <- A
                                              {1, 1, 0, 0, 0, 0, 0, 1}, //A <- B
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //A <- C
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //A <- D
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //A <- E
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //A <- F
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //A <- G
                                              {0, 0, 0, 0, 0, 0, 0, 1}  //A <- a
                                            }, {
                                              {0, 1, 2, 0, 0, 0, 0, 0}, //B <- A
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- B
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- C
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- D
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- E
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- F
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- G
                                              {0, 0, 1, 0, 0, 0, 0, 0}  //B <- a
                                            }, {  
                                              {0, 0, 1, 0, 2, 0, 0, 1}, //C <- A  
                                              {0, 1, 1, 1, 0, 0, 0, 0}, //C <- B
                                              {0, 1, 0, 1, 1, 0, 0, 0}, //C <- C
                                              {0, 1, 1, 0, 0, 0, 0, 0}, //C <- D
                                              {0, 0, 2, 0, 1, 0, 0, 0}, //C <- E
                                              {3, 0, 0, 0, 0, 0, 0, 1}, //C <- F
                                              {0, 0, 1, 0, 1, 0, 0, 0}, //C <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //C <- a
                                            }, {
                                              {1, 0, 0, 1, 0, 1, 0, 1}, //D <- A
                                              {0, 0, 0, 1, 0, 0, 0, 0}, //D <- B
                                              {0, 0, 1, 1, 1, 0, 0, 0}, //D <- C
                                              {0, 0, 0, 1, 1, 0, 0, 0}, //D <- D
                                              {0, 0, 1, 0, 0, 0, 0, 1}, //D <- E
                                              {1, 0, 0, 0, 0, 1, 0, 1}, //D <- F
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //D <- G
                                              {0, 0, 0, 0, 0, 1, 0, 0}  //D <- a
                                            }, {
                                              {0, 0, 0, 0, 2, 1, 1, 2}, //E <- A
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //E <- B
                                              {1, 0, 1, 0, 1, 0, 0, 1}, //E <- C
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //E <- D
                                              {0, 0, 0, 1, 3, 1, 0, 1}, //E <- E
                                              {1, 0, 0, 1, 1, 2, 0, 0}, //E <- F
                                              {0, 0, 0, 0, 0, 0, 1, 1}, //E <- G
                                              {0, 0, 1, 0, 1, 0, 0, 1}  //E <- a
                                            }, {
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //F <- A
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //F <- B
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //F <- C
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //F <- D
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //F <- E
                                              {0, 0, 0, 0, 1, 0, 0, 1}, //F <- F
                                              {0, 0, 0, 0, 0, 1, 1, 1}, //F <- G
                                              {0, 0, 0, 0, 1, 1, 2, 3}  //F <- a
                                            }, {
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //G <- A
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //G <- B
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //G <- C
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //G <- D
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //G <- E
                                              {0, 0, 0, 0, 0, 0, 2, 1}, //G <- F
                                              {0, 0, 0, 0, 0, 1, 0, 1}, //G <- G
                                              {0, 0, 0, 0, 0, 1, 3, 2}  //G <- a
                                            }, {
                                              {0, 0, 0, 0, 0, 0, 1, 1}, //a <- A
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //a <- B
                                              {0, 0, 0, 0, 0, 0, 0, 1}, //a <- C
                                              {0, 0, 0, 0, 0, 0, 1, 1}, //a <- D
                                              {0, 0, 0, 0, 0, 0, 1, 1}, //a <- E
                                              {0, 0, 0, 0, 0, 1, 2, 1}, //a <- F
                                              {0, 0, 0, 0, 0, 2, 1, 1}, //a <- G
                                              {0, 0, 0, 0, 0, 2, 2, 1}  //a <- a
                                            }
                                          };
                                          
  double[][][] secondOrderProbabilitiesLerpMiddle = {
                                            {//A  B  C  D  E  F  G  a  cur  last
                                              {3, 4, 3, 0, 2, 0, 0, 0}, //A <- A
                                              {1, 0, 1, 0, 1, 0, 0, 0}, //A <- B
                                              {1, 1, 0, 0, 0, 0, 0, 0}, //A <- C
                                              {5, 0, 0, 3, 0, 2, 0, 0}, //A <- D
                                              {5, 0, 0, 0, 2, 1, 0, 0}, //A <- E
                                              {1, 1, 0, 0, 1, 0, 0, 0}, //A <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //A <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //A <- a
                                            }, {
                                              {0, 1, 2, 0, 0, 0, 0, 0}, //B <- A
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //B <- C
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- D
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- E
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- F
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- G
                                              {0, 0, 1, 0, 0, 0, 0, 0}  //B <- a
                                            }, {  
                                              {1, 0, 0, 2, 0, 0, 0, 0}, //C <- A  
                                              {1, 0, 1, 2, 0, 0, 0, 0}, //C <- B
                                              {1, 0, 1, 0, 0, 0, 0, 0}, //C <- C
                                              {2, 1, 0, 0, 1, 0, 0, 0}, //C <- D
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //C <- a
                                            }, {
                                              {1, 0, 0, 1, 0, 1, 0, 0}, //D <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //D <- B
                                              {0, 0, 1, 1, 3, 0, 0, 0}, //D <- C
                                              {2, 0, 2, 1, 0, 1, 0, 0}, //D <- D
                                              {0, 0, 1, 0, 1, 0, 0, 0}, //D <- E
                                              {1, 0, 0, 1, 0, 1, 0, 0}, //D <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //D <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //D <- a
                                            }, {
                                              {1, 0, 0, 0, 1, 1, 0, 0}, //E <- A
                                              {1, 0, 0, 0, 1, 1, 0, 0}, //E <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //E <- C
                                              {0, 0, 0, 2, 0, 1, 0, 0}, //E <- D
                                              {2, 0, 0, 2, 0, 1, 0, 0}, //E <- E
                                              {2, 0, 1, 0, 0, 4, 0, 0}, //E <- F
                                              {1, 0, 0, 0, 0, 1, 1, 0}, //E <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //E <- a
                                            }, {
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //F <- A
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //F <- B
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //F <- C
                                              {1, 0, 0, 1, 0, 0, 0, 0}, //F <- D
                                              {0, 0, 0, 0, 1, 1, 1, 0}, //F <- E
                                              {0, 0, 0, 1, 1, 0, 1, 0}, //F <- F
                                              {0, 0, 0, 0, 3, 0, 2, 0}, //F <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //F <- a
                                            }, {
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //G <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //G <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //G <- C
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //G <- D
                                              {0, 0, 0, 0, 1, 1, 0, 0}, //G <- E
                                              {0, 0, 0, 0, 1, 1, 0, 0}, //G <- F
                                              {0, 0, 0, 0, 0, 1, 0, 0}, //G <- G
                                              {1, 0, 0, 0, 0, 1, 0, 0}  //G <- a
                                            }, {
                                              {1, 0, 0, 0, 1, 0, 0, 0}, //a <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- C
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- D
                                              {1, 0, 1, 0, 1, 0, 0, 0}, //a <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- F
                                              {0, 0, 0, 0, 0, 1, 1, 0}, //a <- G
                                              {2, 0, 0, 0, 1, 0, 1, 0}  //a <- a
                                            }
                                          };                                          

  double[][][] secondOrderProbabilities = {
                                            {//A  B  C  D  E  F  G  a  cur  last
                                              {4, 0, 4, 0, 2, 0, 1, 0}, //A <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //A <- B
                                              {2, 0, 1, 0, 1, 0, 0, 0}, //A <- C
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //A <- D
                                              {2, 0, 1, 0, 1, 0, 0, 0}, //A <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //A <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //A <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //A <- 
                                            }, {
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- A
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- B
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- C
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- D
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- E
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- F
                                              {0, 0, 1, 0, 0, 0, 0, 0}, //B <- G
                                              {0, 0, 1, 0, 0, 0, 0, 0}  //B <- a
                                            }, {  
                                              {1, 0, 1, 2, 1, 0, 0, 0}, //C <- A  
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- B
                                              {1, 0, 1, 1, 2, 0, 0, 0}, //C <- C
                                              {1, 0, 0, 1, 0, 0, 0, 0}, //C <- D
                                              {1, 0, 2, 0, 2, 0, 0, 0}, //C <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //C <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //C <- a
                                            }, {
                                              {1, 0, 1, 0, 1, 0, 0, 0}, //D <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //D <- B
                                              {1, 0, 0, 0, 2, 0, 1, 0}, //D <- C
                                              {1, 0, 1, 0, 2, 0, 1, 0}, //D <- D
                                              {1, 0, 1, 0, 1, 0, 0, 0}, //D <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //D <- F
                                              {1, 0, 0, 0, 1, 0, 0, 0}, //D <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //D <- a
                                            }, {
                                              {1, 0, 1, 0, 1, 0, 0, 0}, //E <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //E <- B
                                              {1, 0, 3, 1, 3, 0, 0, 0}, //E <- C
                                              {1, 0, 2, 0, 0, 0, 1, 0}, //E <- D
                                              {1, 0, 1, 1, 1, 0, 1, 0}, //E <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //E <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //E <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //E <- a
                                            }, {
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- C
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- D
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //F <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //F <- a
                                            }, {
                                              {0, 0, 0, 0, 1, 0, 1, 0}, //G <- A
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //G <- B
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //G <- C
                                              {0, 0, 0, 1, 1, 0, 0, 0}, //G <- D
                                              {0, 0, 0, 1, 1, 0, 1, 0}, //G <- E
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //G <- F
                                              {0, 0, 0, 0, 1, 0, 0, 0}, //G <- G
                                              {0, 0, 0, 0, 1, 0, 0, 0}  //G <- a
                                            }, {
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- A
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- B
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- C
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- D
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- E
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- F
                                              {1, 0, 0, 0, 0, 0, 0, 0}, //a <- G
                                              {1, 0, 0, 0, 0, 0, 0, 0}  //a <- a
                                            }
                                          };
  
  //TODO remove 8.!
  double[][][] secondOrderValueProbabilitiesLerpTarget = {
                                                 {//16 8  8. 4  4. 2  2. 1     cur  last
                                                   {2, 1, 0, 0, 0, 0, 0, 0}, //16 - 16
                                                   {2, 1, 0, 0, 0, 0, 0, 0}, //16 - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 8.
                                                   {1, 0, 0, 0, 0, 0, 0, 0}, //16 - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 4.
                                                   {1, 0, 0, 0, 0, 0, 0, 0}, //16 - 2
                                                   {1, 0, 0, 0, 0, 0, 0, 0}, //16 - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //16 - 1
                                                 }, {
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //8  - 16
                                                   {1, 5, 0, 1, 0, 0, 0, 0}, //8  - 8
                                                   {0, 0, 0, 3, 0, 0, 0, 0}, //8  - 8.
                                                   {1, 3, 0, 0, 0, 0, 0, 0}, //8  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 4.
                                                   {1, 1, 0, 0, 0, 0, 0, 0}, //8  - 2
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //8  - 2.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}  //8  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 8
                                                   {1, 1, 0, 1, 0, 0, 0, 0}, //8. - 8.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //8. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 16
                                                   {0, 3, 0, 2, 0, 0, 0, 0}, //4  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 8.
                                                   {1, 3, 0, 0, 0, 0, 0, 0}, //4  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 4.
                                                   {0, 1, 0, 2, 0, 0, 0, 0}, //4  - 2
                                                   {0, 1, 0, 2, 0, 0, 0, 0}, //4  - 2.
                                                   {0, 1, 0, 1, 0, 0, 0, 0}  //4  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //4. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 4.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //4. - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //4. - 1
                                                 }, {
                                                   {1, 2, 0, 1, 0, 0, 0, 0}, //2  - 16
                                                   {1, 2, 0, 1, 0, 0, 0, 0}, //2  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 8.
                                                   {1, 1, 0, 1, 0, 0, 0, 0}, //2  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 4.
                                                   {0, 1, 0, 1, 0, 0, 0, 0}, //2  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //2  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8.
                                                   {0, 1, 0, 1, 0, 0, 0, 0}, //2. - 4
                                                   {1, 0, 0, 1, 0, 0, 0, 0}, //2. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 2
                                                   {0, 1, 0, 2, 0, 0, 0, 0}, //2. - 2.
                                                   {1, 0, 0, 1, 0, 0, 0, 0}  //2. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 8.
                                                   {0, 1, 0, 3, 0, 0, 0, 0}, //1  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //1  - 1
                                                 }
                                               };

  double[][][] secondOrderValueProbabilitiesLerpMiddle = {
                                                 {//16 8  8. 4  4. 2  2. 1     cur  last
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //16 - 16
                                                   {1, 1, 0, 0, 0, 0, 0, 0}, //16 - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 8.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //16 - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //16 - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 16
                                                   {0, 6, 0, 2, 0, 1, 0, 1}, //8  - 8
                                                   {0, 0, 0, 3, 0, 0, 1, 0}, //8  - 8.
                                                   {0, 3, 0, 0, 0, 0, 0, 0}, //8  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 4.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //8  - 2
                                                   {0, 1, 0, 0, 0, 0, 0, 0}, //8  - 2.
                                                   {0, 1, 0, 0, 0, 0, 0, 0}  //8  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 16
                                                   {0, 0, 1, 1, 0, 0, 0, 0}, //8. - 8
                                                   {0, 1, 0, 1, 0, 0, 0, 0}, //8. - 8.
                                                   {0, 0, 1, 1, 0, 0, 0, 0}, //8. - 4
                                                   {0, 0, 1, 1, 0, 0, 0, 0}, //8. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //8. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 16
                                                   {0, 2, 0, 8, 1, 0, 1, 1}, //4  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 8.
                                                   {0, 3, 0, 3, 1, 1, 1, 1}, //4  - 4
                                                   {0, 0, 0, 1, 1, 0, 0, 0}, //4  - 4.
                                                   {0, 1, 0, 2, 0, 0, 0, 0}, //4  - 2
                                                   {0, 1, 0, 2, 0, 0, 1, 1}, //4  - 2.
                                                   {0, 1, 0, 1, 0, 0, 0, 0}  //4  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8.
                                                   {0, 1, 0, 0, 1, 0, 0, 0}, //4. - 4
                                                   {0, 0, 0, 1, 0, 0, 1, 0}, //4. - 4.
                                                   {0, 1, 0, 0, 1, 0, 0, 0}, //4. - 2
                                                   {0, 0, 0, 1, 1, 1, 0, 0}, //4. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //4. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 8.
                                                   {0, 1, 0, 1, 0, 2, 0, 0}, //2  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 4.
                                                   {0, 1, 0, 1, 1, 1, 1, 0}, //2  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //2  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8.
                                                   {0, 1, 0, 1, 0, 0, 1, 0}, //2. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 2
                                                   {0, 1, 0, 2, 1, 0, 0, 0}, //2. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //2. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 8.
                                                   {0, 1, 0, 3, 0, 0, 1, 0}, //1  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //1  - 1
                                                 }
                                               };
                                               
   double[][][] secondOrderValueProbabilities = {
                                                 {//16 8  8. 4  4. 2  2. 1     cur  last
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 8.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //16 - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //16 - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 8.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8  - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //8  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 8.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //8. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //8. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 16
                                                   {0, 0, 0, 1, 0, 0, 1, 1}, //4  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 8.
                                                   {0, 0, 0, 2, 1, 1, 2, 2}, //4  - 4
                                                   {0, 0, 0, 0, 1, 0, 0, 1}, //4  - 4.
                                                   {0, 0, 0, 1, 1, 0, 1, 0}, //4  - 2
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4  - 2.
                                                   {0, 0, 0, 1, 1, 0, 0, 0}  //4  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 8.
                                                   {0, 0, 0, 0, 1, 0, 0, 0}, //4. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //4. - 2
                                                   {0, 0, 0, 0, 1, 0, 0, 0}, //4. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //4. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2  - 8.
                                                   {0, 0, 0, 1, 0, 1, 0, 1}, //2  - 4
                                                   {0, 0, 0, 0, 1, 0, 0, 0}, //2  - 4.
                                                   {0, 0, 0, 1, 0, 1, 0, 0}, //2  - 2
                                                   {0, 0, 0, 1, 1, 0, 0, 0}, //2  - 2.
                                                   {0, 0, 0, 1, 0, 1, 1, 0}  //2  - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 16
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 8.
                                                   {0, 0, 0, 1, 1, 1, 1, 1}, //2. - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //2. - 4.
                                                   {0, 0, 0, 1, 1, 0, 1, 0}, //2. - 2
                                                   {0, 0, 0, 1, 2, 1, 1, 1}, //2. - 2.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}  //2. - 1
                                                 }, {
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 16
                                                   {0, 0, 0, 1, 0, 1, 0, 0}, //1  - 8
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 8.
                                                   {0, 0, 0, 1, 1, 0, 1, 0}, //1  - 4
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 4.
                                                   {0, 0, 0, 1, 0, 0, 0, 0}, //1  - 2
                                                   {0, 0, 0, 1, 0, 0, 1, 0}, //1  - 2.
                                                   {0, 0, 0, 1, 0, 0, 1, 1}  //1  - 1
                                                 }
                                               };
                                               
  double[][][] mutingProbabilities = {
                                       {//0  1  2   cur   last
                                         {8, 1, 0}, //0 - 0
                                         {2, 1, 0}, //0 - 1
                                         {1, 0, 0}  //0 - 2
                                       }, {
                                         {3, 1, 0}, //1 - 0
                                         {1, 7, 0}, //1 - 1
                                         {1, 0, 0}  //1 - 2
                                       }, {
                                         {1, 0, 0}, //2 - 0
                                         {1, 0, 0}, //2 - 1
                                         {1, 0, 0}  //2 - 2
                                       }
                                     };
                                     
  double[][][] mutingProbabilitiesLerpTarget = {
                                       {//0  1  2   cur   last
                                         {0, 0, 1}, //0 - 0
                                         {0, 0, 1}, //0 - 1
                                         {0, 0, 1}  //0 - 2
                                       }, {
                                         {0, 0, 1}, //1 - 0
                                         {0, 0, 1}, //1 - 1
                                         {0, 0, 1}  //1 - 2
                                       }, {
                                         {0, 0, 1}, //2 - 0
                                         {0, 0, 1}, //2 - 1
                                         {0, 1, 7}  //2 - 2
                                       }
                                     };
                                     
  double[][][] legatoProbabilities = {
                                       {
                                         {8, 1},
                                         {1, 0}
                                       }, {
                                         {1, 0},
                                         {1, 0}
                                       }
                                     };

  double[][][] legatoProbabilitiesLerpMiddle = {
                                       {
                                         {6, 1},
                                         {3, 1}
                                       }, {
                                         {1, 0},
                                         {1, 0}
                                       }
                                     };                                     
                                     
  double[][][] legatoProbabilitiesLerpTarget = {
                                       {
                                         {2, 1},
                                         {4, 1}
                                       }, {
                                         {1, 0},
                                         {1, 0}
                                       }
                                     };                                     
                                                
  
  EnumeratedIntegerDistribution[][] secondOrderDistributions;
  EnumeratedIntegerDistribution[][] rhythmDistributions;
  EnumeratedIntegerDistribution[][] mutingDistributions;
  EnumeratedIntegerDistribution[][] legatoDistributions;
  
  Markov() {
    initSecondOrderDistributions();
    initRhythmDistributions();
    initMutingDistributions();
    initLegatoDistributions();
  }
    
  public void initSecondOrderDistributions() {
    secondOrderDistributions = new EnumeratedIntegerDistribution[8][8];
    for(int i = 0; i < 8; i++) {
      for(int j = 0; j < 8; j++) {
        secondOrderDistributions[i][j] = new EnumeratedIntegerDistribution(secOrdStates, secondOrderProbabilities[i][j]);
      }
    }
  }
  
  //TODO variable naming! rhythm vs value etc
  public void initRhythmDistributions() {
    rhythmDistributions = new EnumeratedIntegerDistribution[8][8];
    for(int i = 0; i < 8; i++) {
      for(int j = 0; j < 8; j++) {
        rhythmDistributions[i][j] = new EnumeratedIntegerDistribution(rhythmStates, secondOrderValueProbabilities[i][j]);
      }
    }
  }
  
  public void initMutingDistributions() {
    mutingDistributions = new EnumeratedIntegerDistribution[3][3];
    for(int i = 0; i < 3; i++) {
      for(int j = 0; j < 3; j++) {
        mutingDistributions[i][j] = new EnumeratedIntegerDistribution(mutingStates, mutingProbabilities[i][j]);
      }
    }
  }

  public void initLegatoDistributions() {
    legatoDistributions = new EnumeratedIntegerDistribution[2][2];
    for(int i = 0; i < 2; i++) {
      for(int j = 0; j < 2; j++) {
        legatoDistributions[i][j] = new EnumeratedIntegerDistribution(legatoStates, legatoProbabilities[i][j]);
      }
    }
  }
  
  public int getState() {
    return state;
  }
  
  public int getNextNote() {
      return getNextSecondOrderNote();
  }  
  
  //TODO ughh
  private int getNextSecondOrderNote() {
    int i = 0;
    switch(previousState) {
      case 0:  i = 0; break;
      case 2:  i = 1; break;
      case 3:  i = 2; break;
      case 5:  i = 3; break;
      case 7:  i = 4; break;
      case 8:  i = 5; break;
      case 10: i = 6; break;
      case 12: i = 7; break;
    }
    int j = 0;
    switch(state) {
      case 0:  j = 0; break;
      case 2:  j = 1; break;
      case 3:  j = 2; break;
      case 5:  j = 3; break;
      case 7:  j = 4; break;
      case 8:  j = 5; break;
      case 10: j = 6; break;
      case 12: j = 7; break;
    }
    previousState = state;
    int s = secondOrderDistributions[j][i].sample();
    state = s;
    return s;
  }
  
  //TODO ehhh
  public int getNextValue() {
    // 1 2 3 4 6 8 12 16
    int i = 3;
    switch(previousValue) {
      case 1:  i = 0; break;
      case 2:  i = 1; break;
      case 3:  i = 2; break;
      case 4:  i = 3; break;
      case 6:  i = 4; break;
      case 8:  i = 5; break;
      case 12: i = 6; break;
      case 16: i = 7; break;
    }
    int j = 3;
    switch(value) {
      case 1:  j = 0; break;
      case 2:  j = 1; break;
      case 3:  j = 2; break;
      case 4:  j = 3; break;
      case 6:  j = 4; break;
      case 8:  j = 5; break;
      case 12: j = 6; break;
      case 16: j = 7; break;
    }
    previousValue = value;
    int s = rhythmDistributions[j][i].sample();
    value = s;
    return s;
  }
  
  public int getNextMute() {
    int m = mutingDistributions[muting][previousMuting].sample();
    previousMuting = muting;
    muting = m;
    return m;
  }
  
  public int getNextLegato() {
    int l = legatoDistributions[legato][previousLegato].sample();
    previousLegato = legato;
    legato = l;
    return l;
  }
  
  public void lerpAllMatrices(float f) {
    lerpMuting(f);
    lerpNotes(f);
    lerpValues(f);
    lerpLegato(f);    
  }
  
  public void lerpMuting(float f) {
    for(int i = 0; i < 3; i++) { // TODO yeah i know these should be dynamic
      for(int j = 0; j < 3; j++) { // well sue me
        double[] lerpedRow = lerpRow(mutingProbabilities[i][j], mutingProbabilitiesLerpTarget[i][j], f);
        mutingDistributions[i][j] = new EnumeratedIntegerDistribution(mutingStates, lerpedRow);
      }
    }
  }
  
  public void lerpNotes(float f) {
    if(f < 0.5f) {
      for(int i = 0; i < 8; i++) {
        for(int j = 0; j < 8; j++) {
          double[] lerpedRow = lerpRow(secondOrderProbabilities[i][j], secondOrderProbabilitiesLerpMiddle[i][j], (f*2));
          secondOrderDistributions[i][j] = new EnumeratedIntegerDistribution(secOrdStates, lerpedRow);
        }
      }
    } else {
      for(int i = 0; i < 8; i++) {
        for(int j = 0; j < 8; j++) {
          double[] lerpedRow = lerpRow(secondOrderProbabilitiesLerpMiddle[i][j], secondOrderProbabilitiesLerpTarget[i][j], ((f-0.5f)*2));
          secondOrderDistributions[i][j] = new EnumeratedIntegerDistribution(secOrdStates, lerpedRow);
        }
      }
    }
  }
  
  public void lerpValues(float f) {
    if(f < 0.5f) {
      for(int i = 0; i < 8; i++) {
        for(int j = 0; j < 8; j++) {
          double[] lerpedRow = lerpRow(secondOrderValueProbabilities[i][j], secondOrderValueProbabilitiesLerpMiddle[i][j], (f*2));
          rhythmDistributions[i][j] = new EnumeratedIntegerDistribution(rhythmStates, lerpedRow);
        }
      }
    } else {
      for(int i = 0; i < 8; i++) {
        for(int j = 0; j < 8; j++) {
          double[] lerpedRow = lerpRow(secondOrderValueProbabilitiesLerpMiddle[i][j], secondOrderValueProbabilitiesLerpTarget[i][j], (f-0.5f)*2);
          rhythmDistributions[i][j] = new EnumeratedIntegerDistribution(rhythmStates, lerpedRow);
        }
      }
    }
  }
  
  public void lerpLegato(float f) {
    if(f < 0.5f) {
      for(int i = 0; i < 2; i++) {
        for(int j = 0; j < 2; j++) {
          double[] lerpedRow = lerpRow(legatoProbabilities[i][j], legatoProbabilitiesLerpMiddle[i][j], (f*2));
          legatoDistributions[i][j] = new EnumeratedIntegerDistribution(legatoStates, lerpedRow);
        }
      }
    } else {
      for(int i = 0; i < 2; i++) {
        for(int j = 0; j < 2; j++) {
          double[] lerpedRow = lerpRow(legatoProbabilitiesLerpMiddle[i][j], legatoProbabilitiesLerpTarget[i][j], (f-0.5f)*2);
          legatoDistributions[i][j] = new EnumeratedIntegerDistribution(legatoStates, lerpedRow);
        }
      }
    }
  }
  
  public void lerpMatricesA(float f) {
    lerpNotes(f);
    lerpLegato(f);
  }
  
  public void lerpMatricesB(float f) {
    lerpMuting(f);
    lerpValues(f);
  }
    
  public double[] lerpRow(double[] initial, double[] target, float lerp) {
    double[] lerped = new double[initial.length];
    for(int i = 0; i < initial.length; i++) {
      lerped[i] = initial[i] + lerp*(target[i]-initial[i]);
    }
    return lerped;
  }
  
}
  public void settings() {  size(320, 240); }
  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "--present", "--window-color=#666666", "--hide-stop", "markoviser" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
